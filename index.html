<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jalanin Jogja - Peta Wisata Yogyakarta</title>

    <!-- Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    
    <!-- Leaflet Search Plugin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
      }
      #map {
        height: calc(100vh - 4rem);
        margin-top: 4rem;
        width: 100%;
        z-index: 0;
      }
      #sidebar {
        position: absolute;
        top: 5.25rem; /* 1.25rem + 4rem for navbar */
        left: 1.25rem;
        bottom: 1.25rem;
        width: 380px;
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease-in-out;
      }
      #sidebar.collapsed {
        transform: translateX(calc(-100% - 1.25rem));
      }
      #sidebar-toggle {
        position: absolute;
        top: 5.25rem; /* 1.25rem + 4rem for navbar */
        left: calc(380px + 1.25rem + 1rem);
        width: 40px;
        height: 40px;
        background-color: white;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: left 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
      #sidebar.collapsed + #sidebar-toggle {
        left: 1.25rem;
      }
      #sidebar-toggle i {
        transition: transform 0.3s ease-in-out;
      }
      #sidebar.collapsed + #sidebar-toggle i {
        transform: rotate(180deg);
      }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
      .leaflet-control-layers {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .leaflet-control-zoom { border: none !important; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
      .leaflet-control-zoom a { background-color: white !important; color: #333 !important; }
      .leaflet-control-zoom a:hover { background-color: #f4f4f4 !important; }
      .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
      .leaflet-popup-content { margin: 15px; font-size: 14px; line-height: 1.6; }
      .leaflet-popup-content h3 { margin: 0 0 10px; font-size: 18px; font-weight: 600; color: #333; }
      .leaflet-popup-content p { margin: 0 0 15px 0; }
      .leaflet-popup-content img { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px; }
      .custom-div-icon { display: flex; justify-content: center; align-items: center; border-radius: 50%; color: white; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.25); border: 2px solid white; }
      .route-button { display: block; width: 100%; padding: 10px; background-color: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; text-align: center; transition: background-color 0.2s; }
      .route-button:hover { background-color: #2563eb; }
      .leaflet-routing-container { display: none; }
      .wisata-list-item { padding: 10px 12px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s; font-weight: 500; }
      .wisata-list-item:hover { background-color: #f0f2f5; }
      .route-info-popup .leaflet-popup-content-wrapper { background-color: #3b82f6; color: white; border-radius: 8px; }
      .route-info-popup .leaflet-popup-content { margin: 10px 15px; font-size: 14px; }
      .route-info-popup .leaflet-popup-tip { background: #3b82f6; }
      
      /* Leaflet Search Customization */
      #search-control-container .leaflet-control-search {
        position: relative;
        box-shadow: none;
      }
      #search-control-container .leaflet-control-search .search-input {
        width: 100%;
        border-radius: 9999px;
        border: 1px solid transparent;
        background-color: #f0f2f5;
        padding-left: 1rem;
        height: 40px;
        transition: all 0.2s;
      }
      #search-control-container .leaflet-control-search .search-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px #3b82f6;
      }
      #search-control-container .leaflet-control-search .search-button {
        right: 0.75rem;
        left: auto;
        top: 9px;
        font-size: 1.1rem;
        color: #9ca3af;
        display: none;
      }
      #search-control-container .leaflet-control-search .search-alert {
        top: 45px;
        left: 0;
        right: 0;
      }
      #search-control-container .leaflet-control-search .search-tooltip {
        width: 100%;
        max-height: calc(100vh - 300px);
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <nav class="bg-white/80 backdrop-blur-sm shadow-md fixed top-0 left-0 right-0 z-[1002]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="landing.html" class="flex items-center space-x-3">
                            <img src="img/tugu_jogja.jpg" alt="Logo Jalanin Jogja" class="w-10 h-10 rounded-full">
                            <span class="text-xl font-bold text-gray-800">Jalanin Jogja</span>
                        </a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium">Peta</a>
                        <a href="daftar_lokasi.html" class="text-gray-600 hover:bg-gray-200 hover:text-gray-800 px-3 py-2 rounded-md text-sm font-medium">Daftar Lokasi Wisata</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div id="map"></div>
    <div id="sidebar">
      <div class="p-6">
        <div class="flex items-center mb-5">
          <img src="img/tugu_jogja.jpg" alt="Logo Jalanin Jogja" class="w-12 h-12 mr-4 rounded-full">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Jalanin Jogja</h1>
            <p class="text-sm text-gray-500">Peta Wisata Yogyakarta</p>
          </div>
        </div>
        <div id="search-control-container"></div>
      </div>

      <div class="flex-grow overflow-y-auto custom-scrollbar px-6 pb-6">
        <div id="layer-control" class="space-y-1"></div>
      </div>

      <div class="p-6 border-t border-gray-200">
        <button
          id="clear-route-btn"
          class="w-full bg-red-500 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-red-600 transition-colors disabled:bg-red-300 disabled:cursor-not-allowed flex items-center justify-center"
        >
          <i class="fas fa-times-circle mr-2"></i>
          <span>Hapus Rute</span>
        </button>
      </div>
    </div>

    <div id="sidebar-toggle">
      <i class="fas fa-chevron-left"></i>
    </div>

    <script>
      // Variabel
      let routingControl = null;
      let routeInfoPopup = null;
      const sidebar = document.getElementById("sidebar");
      const layerGroups = {};
      const searchableMarkers = L.featureGroup();
      let wisataData = [];

      // 1. Konfigurasi Kategori
      const categories = {
        kuliner: { label: "Wisata Kuliner", icon: "fas fa-utensils", color: "#F87171" },
        alam: { label: "Wisata Alam", icon: "fas fa-tree", color: "#34D399" },
        pantai: { label: "Wisata Pantai", icon: "fas fa-water", color: "#60A5FA" },
        museum: { label: "Wisata Museum", icon: "fas fa-building-columns", color: "#A78BFA" },
        buatan: { label: "Wisata Buatan", icon: "fas fa-hammer", color: "#78716C" },
        candi: { label: "Wisata Candi", icon: "fas fa-gopuram", color: "#F59E0B" },
      };
      
      const categoryMap = {
        "Wisata Kuliner": "kuliner",
        "Wisata Alam": "alam",
        "Wisata Pantai": "pantai",
        "Wisata Museum": "museum",
        "Wisata Buatan": "buatan",
        "Wisata Candi": "candi",
      };

      // 2. Inisialisasi Peta
      const map = L.map("map", { zoomControl: false }).setView([-7.7956, 110.3695], 10);
      L.control.zoom({ position: "bottomright" }).addTo(map);
      searchableMarkers.addTo(map);

      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
      const esriSatellite = L.esri.basemapLayer("Imagery"); 
      const baseMaps = { Street: osm, Satelit: esriSatellite };

      const batasAdminPg = L.tileLayer.wms("http://localhost:8080/geoserver/pgweb/wms", {
        layers: "pgweb:Batas_Admin",
        format: "image/png",
        transparent: true,
        attribution: "Batas Administrasi",
        opacity: 0.45
      });

      const overlayMaps = {
          "Batas Administrasi": batasAdminPg
      };
      
      L.control.layers(baseMaps, overlayMaps, { position: "topright" }).addTo(map);

      const layerControlContainer = document.getElementById("layer-control");

      // 3. Fungsi Helper (menampilkan lokasi wisata tertentu di peta Leaflet)
      function showLocation(lat, lon) {
        const place = wisataData.find((p) => p.lat === lat && p.lon === lon);
        if (place && place.marker) {
          if (sidebar.classList.contains("collapsed")) {
            sidebar.classList.remove("collapsed");
            setTimeout(() => map.invalidateSize(), 300);
          }
          if (!map.hasLayer(layerGroups[place.category])) {
            map.addLayer(layerGroups[place.category]);
            document.getElementById(place.category).checked = true;
          }
          map.flyTo([lat, lon], 15);
          place.marker.openPopup();
        }
      }

      function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        return [hours > 0 ? `${hours} jam` : "", minutes > 0 ? `${minutes} menit` : ""].filter(Boolean).join(" ") || "Kurang dari 1 menit";
      }

      function formatDistance(meters) {
        return (meters / 1000).toFixed(2) + " km";
      }

      // 4. Memuat dan Memproses Data
      $.getJSON("get_wisata.php", function (data) {
        if (data.status !== 'success') {
          console.error("Gagal memuat data:", data.message);
          alert("Gagal memuat data dari server. Pastikan get_wisata.php berjalan.");
          return;
        }
        wisataData = data.wisata.map((item) => {
          const cat = categoryMap[item.kategori] || "buatan";
          return {
            id: item.id,
            name: item.nama_wisata,
            category: cat,
            lat: parseFloat(item.latitude),
            lon: parseFloat(item.longitude),
            desc: item.deskripsi,
            img: item.img ? `img/${item.img}` : `https://placehold.co/300x200/EEE/31343C?text=Gambar+Tidak+Tersedia`,
            marker: null,
          };
        });
        initializeUI();
      }).fail(function (jqXHR, textStatus, errorThrown) {
        let errorMsg = "Gagal menghubungi server. Pastikan XAMPP dan file PHP sudah benar.";
        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
          errorMsg += "\n\nDetail Error: " + jqXHR.responseJSON.message;
        } else if (jqXHR.responseText) {
          errorMsg += "\n\nRespons Server:\n" + jqXHR.responseText.substring(0, 500);
        }
        alert(errorMsg);
        console.error("Failed to load data:", textStatus, errorThrown, jqXHR.responseText);
      });

      // 5. Inisialisasi UI setelah data dimuat
      function initializeUI() {
        for (const catKey in categories) {
          layerGroups[catKey] = L.layerGroup();
          const categoryInfo = categories[catKey];
          const customIcon = L.divIcon({
            html: `<div class="custom-div-icon" style="background-color: ${categoryInfo.color};"><i class="${categoryInfo.icon}"></i></div>`,
            className: "", iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32],
          });
          const filteredData = wisataData.filter(
            (item) => item.category === catKey
          );
      
          filteredData.sort((a, b) => a.name.localeCompare(b.name));
      
          let listHtml = "";
          filteredData.forEach((item) => {
            const marker = L.marker([item.lat, item.lon], { icon: customIcon, title: item.name });
            const popupContent = `
              <div>
                <img src="${item.img}" alt="${item.name}">
                <h3>${item.name}</h3>
                <p>${item.desc || 'Deskripsi tidak tersedia.'}</p>
                <div class="reviews-container" data-wisata-id="${item.id}"></div>
                <button onclick="getRoute(${item.lat}, ${item.lon})" class="route-button">
                    <i class="fas fa-directions mr-2"></i> Rute
                </button>
              </div>`;
            marker.bindPopup(popupContent);

            // membangun daftar lokasi wisata 
            layerGroups[catKey].addLayer(marker);
            searchableMarkers.addLayer(marker);
            item.marker = marker;
            listHtml += `<div class="wisata-list-item" onclick="showLocation(${item.lat}, ${item.lon})">${item.name}</div>`;
          });
          layerGroups[catKey].addTo(map);
      
          // membangun layer control untuk setiap kategori wisata
          const controlHtml = `
            <div class="category-group">
              <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 cursor-pointer" id="toggle-${catKey}">
                <div class="flex items-center">
                  <input type="checkbox" id="${catKey}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer mr-4" checked>
                  <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3" style="background-color: ${categoryInfo.color}33;">
                      <i class="${categoryInfo.icon}" style="color: ${categoryInfo.color};"></i>
                  </div>
                  <span class="font-semibold text-gray-700">${categoryInfo.label}</span>
                </div>
                <div class="flex items-center">
                  <i id="arrow-${catKey}" class="fas fa-chevron-down transition-transform duration-300 text-gray-500"></i>
                </div>
              </div>
              <div id="list-${catKey}" class="pl-20 pr-4 pt-1 space-y-1 text-sm hidden">
                  ${listHtml}
              </div>
            </div>`;
          layerControlContainer.innerHTML += controlHtml;
        }
      
        // 6. Event Listeners untuk UI
        for (const catKey in categories) {
          const checkbox = document.getElementById(catKey);
          const toggleButton = document.getElementById(`toggle-${catKey}`);
          checkbox.addEventListener("change", function () {
            if (this.checked) map.addLayer(layerGroups[catKey]);
            else map.removeLayer(layerGroups[catKey]);
          });
          checkbox.addEventListener("click", (e) => e.stopPropagation());
          toggleButton.addEventListener("click", () => {
            document.getElementById(`list-${catKey}`).classList.toggle("hidden");
            document.getElementById(`arrow-${catKey}`).classList.toggle("rotate-180");
          });
        }
        
        // Inisialisasi Leaflet-Search di dalam sidebar
        const searchControl = new L.Control.Search({
            layer: searchableMarkers,
            propertyName: 'title',
            initial: false,
            zoom: 15,
            marker: false,
            textPlaceholder: 'Cari Wisata...',
            container: 'search-control-container',
            collapsed: false
        });
        map.addControl(searchControl);
      }

      // 7. Event Listeners untuk UI Global
      const clearRouteBtn = document.getElementById("clear-route-btn");
      clearRouteBtn.disabled = true;
      clearRouteBtn.addEventListener("click", function () {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
          this.disabled = true;
        }
        if (routeInfoPopup) map.removeLayer(routeInfoPopup);
      });

      const sidebarToggle = document.getElementById("sidebar-toggle");
      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        sidebarToggle.querySelector("i").classList.toggle("fa-chevron-left");
        sidebarToggle.querySelector("i").classList.toggle("fa-chevron-right");
        setTimeout(() => map.invalidateSize(), 300);
      });

      // 8. Fungsi Rute
      function getRoute(destLat, destLon) {
        if (!navigator.geolocation) return alert("Geolocation tidak didukung oleh browser Anda.");
        navigator.geolocation.getCurrentPosition(
          (position) => {
            if (routingControl) map.removeControl(routingControl);
            if (routeInfoPopup) map.removeLayer(routeInfoPopup);
            routingControl = L.Routing.control({
              waypoints: [ L.latLng(position.coords.latitude, position.coords.longitude), L.latLng(destLat, destLon) ],
              routeWhileDragging: false,
              lineOptions: { styles: [{ color: "#2563EB", opacity: 0.8, weight: 6 }] },
              createMarker: () => null,
            }).addTo(map);

            routingControl.on("routesfound", function (e) {
              const summary = e.routes[0].summary;
              const destination = e.routes[0].waypoints.slice(-1)[0].latLng;
              const popupContent = `
                <div class="text-white">
                  <p class="font-bold"><i class="fas fa-road mr-2"></i>${formatDistance(summary.totalDistance)}</p>
                  <p class="font-bold"><i class="fas fa-clock mr-2"></i>${formatTime(summary.totalTime)}</p>
                </div>`;
              routeInfoPopup = L.popup({ offset: L.point(0, -32), closeButton: false, className: "route-info-popup" })
                .setLatLng(destination).setContent(popupContent).openOn(map);
            });
            map.closePopup();
            clearRouteBtn.disabled = false;
          },
          () => alert("Tidak bisa mendapatkan lokasi Anda. Pastikan Anda mengizinkan akses lokasi.")
        );
      }

      // 9. Fungsi Lokasi Terkini
      let currentLocationMarker = null;
      function showCurrentLocation() {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude: lat, longitude: lon } = position.coords;
            if (currentLocationMarker) map.removeLayer(currentLocationMarker);
            const currentLocationIcon = L.divIcon({
              html: `<div style="background-color: #3B82F6; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px #3B82F6;"></div>`,
              className: "", iconSize: [16, 16],
            });
            currentLocationMarker = L.marker([lat, lon], { icon: currentLocationIcon }).addTo(map);
            map.flyTo([lat, lon], 16);
            currentLocationMarker.bindPopup("<b>Lokasi Anda</b>");
          },
          () => { console.log("Tidak bisa mendapatkan lokasi Anda."); }
        );
      }

      // Initial Load
      showCurrentLocation();
      map.invalidateSize();
    </script>
  </body>
</html>
